#!/bin/bash

set -e

URL="http://ftpmirror.gnu.org/emacs/emacs-23.4.tar.bz2"
PREFIX="$EVM_HOME/installations/emacs-23.4"
CONF_OPTS=()

mkdir -p $PREFIX

if [[ "$OSTYPE" == "darwin"* ]]; then
  CONF_OPTS=("${CONF_OPTS[@]}" --without-dbus --without-x --with-ns)
elif [[ "$OSTYPE" == "linux"* ]]; then
  CONF_OPTS=("${CONF_OPTS[@]}" \
      "--with-crt-dir=$(dirname $(gcc -print-file-name=crt1.o))")  # [#1]_
fi
# .. [#1] Avoid the following error:
#      configure: error: crt*.o not found.
#        Use --with-crt-dir to specify the location.

TAR_FILE="$EVM_HOME/tars/emacs-23.4.tar.bz2"
if [[ ! -f $TAR_FILE ]]; then
  wget $URL -O $TAR_FILE
fi

CACHE_DIR="$EVM_HOME/cache"
EMACS_DIR="$CACHE_DIR/emacs-23.4"

if [[ ! -d $EMACS_DIR ]]; then
  tar -xvjf $TAR_FILE -C $CACHE_DIR
fi

cd $EMACS_DIR

./configure --prefix=$PREFIX "${CONF_OPTS[@]}"
make bootstrap
make install

if [[ "$OSTYPE" == "darwin"* ]]; then
  cp -r "nextstep/Emacs.app" $PREFIX
fi
